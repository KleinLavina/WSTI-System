{% extends "admin/layout/base.html" %}
{% block title %}Review Work Item{% endblock %}

{% block content %}

<style>
/* ===============================
   LAYOUT
================================ */
.review-layout{
  display:grid;
  grid-template-columns:1fr 340px;
  gap:20px;
}

/* ===============================
   HEADER
================================ */
.review-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:18px;
}

.review-title h4{
  margin:0;
  font-weight:700;
}

.review-sub{
  font-size:.8rem;
  color:#6b7280;
}

/* ===============================
   LEFT PANEL (BASE)
================================ */
.review-main{
  border-radius:16px;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 28px rgba(15,23,42,.08);
  padding:20px;
  transition:.25s ease;
}

/* Soft backgrounds based on review state */
.review-main.approved{
  background:#eff6ff;
  border-color:#bfdbfe;
}

.review-main.revision{
  background:#fef2f2;
  border-color:#fecaca;
}

.review-main.pending{
  background:#fffbeb;
  border-color:#fde68a;
}

/* ===============================
   INFO ROW
================================ */
.review-info{
  display:flex;
  gap:20px;
  font-size:.8rem;
  color:#374151;
  margin-bottom:14px;
  align-items:center;
}

.review-pill{
  padding:4px 10px;
  border-radius:999px;
  font-size:.7rem;
  font-weight:700;
}

.review-pill.approved{ background:#dbeafe;color:#1e40af; }
.review-pill.revision{ background:#fee2e2;color:#991b1b; }
.review-pill.pending{ background:#fef3c7;color:#92400e; }

/* ===============================
   SECTIONS
================================ */
.review-section{
  margin-top:16px;
}

.review-section-title{
  font-size:.7rem;
  font-weight:800;
  color:#6b7280;
  text-transform:uppercase;
  margin-bottom:6px;
}

/* ===============================
   MESSAGE
================================ */
.review-message{
  background:#ffffff;
  border-radius:12px;
  padding:14px;
  font-size:.85rem;
  line-height:1.5;
  border:1px solid #e5e7eb;
}

.review-message-short{
  background:#ffffff;
  border-radius:12px;
  padding:14px;
  width:fit-content;
  font-size:.85rem;
  line-height:1.5;
  border:1px solid #e5e7eb;
}
/* ===============================
   ATTACHMENTS
================================ */
.attachment-group{
  border:1px solid #e5e7eb;
  border-radius:12px;
  margin-top:10px;
  overflow:hidden;
}

.attachment-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 14px;
  cursor:pointer;
  background:#f9fafb;
  font-size:.8rem;
  font-weight:700;
}

.attachment-header i{
  transition:transform .2s ease;
}

.attachment-header.collapsed i{
  transform:rotate(-90deg);
}

.attachment-body{
  display:none;
  padding:10px;
  background:#ffffff;
}

.review-attachment{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  border-radius:8px;
  background:#f9fafb;
  font-size:.8rem;
  margin-bottom:6px;
}

/* ===============================
   RIGHT PANEL
================================ */
.review-side{
  position:sticky;
  top:20px;
  height:fit-content;
  background:#ffffff;
  border-radius:16px;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 28px rgba(15,23,42,.08);
  padding:18px;
}

.review-side h6{
  font-weight:800;
  margin-bottom:12px;
}

/* ===============================
   ACTION BUTTONS
================================ */
.review-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.review-btn{
  width:100%;
  padding:10px;
  border-radius:12px;
  font-weight:700;
  font-size:.8rem;
  border:1px solid transparent;
  transition:.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.review-btn.pending{
  background:#fef3c7;
  color:#92400e;
  border-color:#fde68a;
}

.review-btn.approved{
  background:#dbeafe; /* LIGHT BLUE */
  color:#1e40af;
  border-color:#93c5fd;
}

.review-btn.revision{
  background:#fee2e2;
  color:#991b1b;
  border-color:#fecaca;
}

.review-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(15,23,42,.12);
}
.wc-header-divider {
  margin: 0.875rem 0;
  border: 0;
  border-top: 1px solid black;
}
</style>

<!-- ===============================
     HEADER
================================ -->
<div class="review-header">
  <div class="review-title">
    <h4>
      <i class="fas fa-eye text-primary me-1"></i>
      Review Submission
    </h4>
    <div class="review-sub">
      {{ work_item.workcycle.title }}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a href="#"
       class="btn btn-sm btn-outline-primary"
       data-qxdlg-trigger
       data-qxdlg-url="{% url 'admin_app:work-item-discussion' work_item.id %}">
      <i class="fas fa-comments me-1"></i> Discussion
    </a>

    <a href="{% url 'admin_app:done-workers-by-workcycle' work_item.workcycle.id %}"
       class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Back
    </a>
  </div>
</div>

 <hr class="wc-header-divider">

<div class="review-layout">

  <!-- ===============================
       LEFT PANEL
  ================================ -->
  <div class="review-main {{ work_item.review_decision }}">

    <div class="review-info">
      <div>
        <i class="far fa-user me-1"></i>
        <strong>{{ work_item.owner.get_full_name|default:work_item.owner.username }}</strong>
      </div>

      <div>
        <i class="far fa-clock me-1"></i>
        {{ work_item.submitted_at|date:"l, F j, Y · g:i A" }}
      </div>

      <div class="review-pill {{ work_item.review_decision }}">
        {{ work_item.get_review_decision_display }}
      </div>
    </div>
    <!-- ===============================
     STATUS LABEL
================================ -->
{% if work_item.status_label %}
<div class="review-section">
  <div class="review-section-title">
    <i class="fas fa-tag me-1"></i> Status Label
  </div>
  <div class="review-message-short">
    {{ work_item.status_label }}
  </div>
</div>
{% endif %}

    <div class="review-section">
      <div class="review-section-title">Worker Message</div>
      <div class="review-message">
        {{ work_item.message|default:"No message provided."|linebreaksbr }}
      </div>
    </div>

    <!-- ===============================
         ATTACHMENTS
    ================================ -->
    <div class="review-section">
      <div class="review-section-title">Attachments</div>

      {% for type, files in attachments_by_type.items %}
      <div class="attachment-group">
        <div class="attachment-header collapsed" onclick="toggleAttachment(this)">
          <span>
            <i class="fas fa-paperclip me-1"></i> {{ type }}
          </span>
          <i class="fas fa-chevron-down"></i>
        </div>

        <div class="attachment-body">
          {% for f in files %}
          <div class="review-attachment">
            <a href="{{ f.file.url }}" target="_blank">
              <i class="far fa-file me-1"></i>
              {{ f.file.name|slice:"-40:" }}
            </a>
            <span class="text-muted">
              {{ f.uploaded_at|date:"M d, Y · g:i A" }}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% empty %}
        <div class="text-muted small fst-italic">No attachments submitted.</div>
      {% endfor %}
    </div>

  </div>

  <!-- ===============================
       RIGHT PANEL
  ================================ -->
  <div class="review-side">
    <h6>Review Decision</h6>

    <form method="post" class="review-actions">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_review">

      <button name="review_decision" value="pending" class="review-btn pending">
        <i class="fas fa-hourglass-half"></i> Mark as Pending
      </button>

      <button name="review_decision" value="approved" class="review-btn approved">
        <i class="fas fa-check-circle"></i> Approve Work
      </button>

      <button name="review_decision" value="revision" class="review-btn revision">
        <i class="fas fa-undo-alt"></i> Needs Revision
      </button>
    </form>
  </div>

</div>

<script>
function toggleAttachment(header){
  header.classList.toggle("collapsed");
  header.nextElementSibling.style.display =
    header.nextElementSibling.style.display === "block" ? "none" : "block";
}
</script>

{% include "admin/page/modals/message_ui_modal.html" %}
{% endblock %}
