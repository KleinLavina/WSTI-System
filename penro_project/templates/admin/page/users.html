{% extends "admin/layout/base.html" %}
{% block title %}Users{% endblock %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/users_styles.css' %}">
<script src="{% static 'js/users_scripts.js' %}"></script>
<!-- =========================
     UNIFIED HEADER (ENHANCED)
========================= -->
<div class="wc-unified-header">

  <!-- TOP ROW: Title + Action Buttons -->
  <div class="wc-header-top">
    <div class="wc-title-section">
      <h3 class="wc-main-title">
        <i class="fas fa-users"></i>
        Users
        <span class="wc-user-count">{{ total_users }}</span>
      </h3>
      <p class="wc-subtitle">
        Manage user directory, roles, permissions, and organizational structure
      </p>
    </div>

    <!-- ACTION BUTTONS (RIGHT SIDE) -->
    <div class="wc-action-buttons-top">
      <button
        type="button"
        class="wc-info-btn"
        data-bs-toggle="modal"
        data-bs-target="#usersHelpModal">
        <i class="fas fa-question-circle"></i>
        User Management Guide
      </button>

      <a
        href="{% url 'admin_app:manage-organization' %}"
        class="wc-organization-btn">
        <i class="fas fa-sitemap"></i>
        Organization
      </a>

      <button
        type="button"
        class="wc-create-btn"
        data-bs-toggle="modal"
        data-bs-target="#createUserModal">
        <i class="fas fa-user-plus"></i>
        Add User
      </button>
    </div>
  </div>

  <!-- BOTTOM ROW: Filters + Search + Sort (HORIZONTAL) -->
  <div class="wc-header-bottom">
    

    <!-- RIGHT: SEARCH & SORT (HORIZONTAL) -->
    <div class="wc-search-sort-section">
      <!-- SEARCH -->
      <form method="get" class="wc-search-form">
        {% if current_division %}<input type="hidden" name="division" value="{{ current_division }}">{% endif %}
        {% if current_section %}<input type="hidden" name="section" value="{{ current_section }}">{% endif %}
        {% if current_service %}<input type="hidden" name="service" value="{{ current_service }}">{% endif %}
        {% if current_unit %}<input type="hidden" name="unit" value="{{ current_unit }}">{% endif %}
        {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}

        <div class="wc-search-wrapper">
          <i class="fas fa-search wc-search-icon"></i>
          <input type="search"
                 name="q"
                 value="{{ search_query }}"
                 class="wc-search-input"
                 placeholder="Search users...">
          <button type="submit" class="wc-search-btn">
            Search
          </button>
        </div>
      </form>

      <!-- SORT -->
      <div class="wc-sort-wrapper">
        <div class="wc-sort-buttons">
          <a href="?sort=name_asc{% if current_division %}&division={{ current_division }}{% endif %}{% if current_section %}&section={{ current_section }}{% endif %}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_unit %}&unit={{ current_unit }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
             class="wc-sort-btn {% if current_sort == 'name_asc' %}active{% endif %}"
             title="Sort by Name (A-Z)">
            <i class="fas fa-sort-alpha-up"></i>
          </a>
          <a href="?sort=name_desc{% if current_division %}&division={{ current_division }}{% endif %}{% if current_section %}&section={{ current_section }}{% endif %}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_unit %}&unit={{ current_unit }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
             class="wc-sort-btn {% if current_sort == 'name_desc' %}active{% endif %}"
             title="Sort by Name (Z-A)">
            <i class="fas fa-sort-alpha-down"></i>
          </a>
          <a href="?sort=date_desc{% if current_division %}&division={{ current_division }}{% endif %}{% if current_section %}&section={{ current_section }}{% endif %}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_unit %}&unit={{ current_unit }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
             class="wc-sort-btn {% if current_sort == 'date_desc' %}active{% endif %}"
             title="Recently Joined">
            <i class="fas fa-calendar-plus"></i>
          </a>
          <a href="?sort=date_asc{% if current_division %}&division={{ current_division }}{% endif %}{% if current_section %}&section={{ current_section }}{% endif %}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_unit %}&unit={{ current_unit }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
             class="wc-sort-btn {% if current_sort == 'date_asc' %}active{% endif %}"
             title="Early Members">
            <i class="fas fa-calendar-minus"></i>
          </a>
          <a href="?sort=role_asc{% if current_division %}&division={{ current_division }}{% endif %}{% if current_section %}&section={{ current_section }}{% endif %}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_unit %}&unit={{ current_unit }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}"
             class="wc-sort-btn {% if current_sort == 'role_asc' %}active{% endif %}"
             title="Sort by Role">
            <i class="fas fa-user-tag"></i>
          </a>
        </div>
      </div>
    </div>

  </div>

    <!-- LEFT: ORG FILTERS -->
    <div class="wc-filters-section">
      <div class="wc-section-label">
        <i class="fas fa-filter"></i>
        Filter by Organization
      </div>
      <div class="wc-filters">
        <!-- Division Filter -->
        <div class="wc-filter-dropdown">
          <button class="wc-filter-btn {% if current_division %}active{% endif %}" id="divisionFilterBtn">
            <i class="fas fa-building"></i>
            <span>{{ current_division_name|default:"Division" }}</span>
            <i class="fas fa-chevron-down wc-dropdown-icon"></i>
          </button>
          <div class="wc-filter-menu" id="divisionFilterMenu">
            <a href="?{% if current_sort %}sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if not current_division %}active{% endif %}">
              All Divisions
            </a>
            {% for division in divisions %}
            <a href="?division={{ division.id }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if current_division == division.id|stringformat:'s' %}active{% endif %}">
              {{ division.name }}
            </a>
            {% endfor %}
          </div>
        </div>

        <!-- Section Filter (conditional) -->
        {% if current_division and sections %}
        <div class="wc-filter-dropdown">
          <button class="wc-filter-btn {% if current_section %}active{% endif %}" id="sectionFilterBtn">
            <i class="fas fa-layer-group"></i>
            <span>{{ current_section_name|default:"Section" }}</span>
            <i class="fas fa-chevron-down wc-dropdown-icon"></i>
          </button>
          <div class="wc-filter-menu" id="sectionFilterMenu">
            <a href="?division={{ current_division }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if not current_section %}active{% endif %}">
              All Sections
            </a>
            {% for section in sections %}
            <a href="?division={{ current_division }}&section={{ section.id }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if current_section == section.id|stringformat:'s' %}active{% endif %}">
              {{ section.name }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Service Filter (conditional) -->
        {% if current_section and services %}
        <div class="wc-filter-dropdown">
          <button class="wc-filter-btn {% if current_service %}active{% endif %}" id="serviceFilterBtn">
            <i class="fas fa-sitemap"></i>
            <span>{{ current_service_name|default:"Service" }}</span>
            <i class="fas fa-chevron-down wc-dropdown-icon"></i>
          </button>
          <div class="wc-filter-menu" id="serviceFilterMenu">
            <a href="?division={{ current_division }}&section={{ current_section }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if not current_service %}active{% endif %}">
              All Services
            </a>
            {% for service in services %}
            <a href="?division={{ current_division }}&section={{ current_section }}&service={{ service.id }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if current_service == service.id|stringformat:'s' %}active{% endif %}">
              {{ service.name }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Unit Filter (conditional) -->
        {% if current_section and units %}
        <div class="wc-filter-dropdown">
          <button class="wc-filter-btn {% if current_unit %}active{% endif %}" id="unitFilterBtn">
            <i class="fas fa-users"></i>
            <span>{{ current_unit_name|default:"Unit" }}</span>
            <i class="fas fa-chevron-down wc-dropdown-icon"></i>
          </button>
          <div class="wc-filter-menu" id="unitFilterMenu">
            <a href="?division={{ current_division }}&section={{ current_section }}{% if current_service %}&service={{ current_service }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if not current_unit %}active{% endif %}">
              All Units
            </a>
            {% for unit in units %}
            <a href="?division={{ current_division }}&section={{ current_section }}{% if current_service %}&service={{ current_service }}{% endif %}&unit={{ unit.id }}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
               class="wc-filter-option {% if current_unit == unit.id|stringformat:'s' %}active{% endif %}">
              {{ unit.name }}
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Clear Filters Button -->
        {% if current_division or current_section or current_service or current_unit %}
        <a href="?{% if current_sort %}sort={{ current_sort }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}" 
           class="wc-clear-filters-btn">
          <i class="fas fa-times-circle"></i>
          Clear Filters
        </a>
        {% endif %}
      </div>
    </div>


</div>

<!-- =========================
     USER GRID (INCLUDE)
========================= -->
<section class="wc-content-area">
  {% include "admin/page/includes/users_grid.html" %}
</section>

<!-- =========================
     MODALS
========================= -->
{% include "admin/page/modals/create_user_modal.html" %}

<!-- USERS HELP MODAL -->
<div class="modal fade" id="usersHelpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-question-circle me-2"></i>
          User Management Guide
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Manage your organization's user accounts with these features:</p>
        <ul class="mb-0">
          <li><strong>Add User</strong>: Register new users with customized roles</li>
          <li><strong>Organization View</strong>: Visualize user hierarchy and departments</li>
          <li><strong>Organizational Filters</strong>: Filter by Division, Section, Service, and Unit</li>
          <li><strong>Search & Sort</strong>: Find and organize users by name, date joined, or role</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ONBOARDING MODAL -->
<div class="modal fade"
     id="onboardModal"
     tabindex="-1"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-onboard-compact">
    <div class="modal-content onboard-modal-content">
      <div class="modal-body p-0" id="onboardModalBody">
        <div class='loading-spinner'>
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>




{% endblock %}