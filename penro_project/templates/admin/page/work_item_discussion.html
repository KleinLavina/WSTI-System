{% extends "admin/layout/base.html" %}
{% block title %}Work Item Discussion{% endblock %}

{% block content %}

<div class="container-fluid">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
    <div>
      <h5 class="fw-bold mb-1 d-flex align-items-center gap-2">
        <i class="fas fa-comments text-primary"></i>
        Work Item Discussion
      </h5>

      <div class="text-muted small">
        <strong>{{ work_item.workcycle.title }}</strong>
        · Assigned to
        {{ work_item.owner.get_full_name|default:work_item.owner.username }}
        · Due {{ work_item.workcycle.due_at|date:"M d, Y" }}
      </div>

      <!-- UNIQUE THREAD IDENTIFIER -->
      <div class="small text-muted">
        Thread ID:
        <span class="badge bg-light text-dark">
          #{{ work_item.id }}
        </span>
      </div>
    </div>

    <a href="{% url 'admin_app:work-item-review' work_item.id %}"
       class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i>
      Back to Review
    </a>
  </div>

  <!-- THREAD (GROUP CHAT) -->
  <div class="card mb-3">
    <div class="card-body">

      {% if messages %}
        {% for m in messages %}
        <div class="mb-3 pb-2 border-bottom">

          <div class="d-flex align-items-center gap-2 small fw-semibold">
            {{ m.sender.get_full_name|default:m.sender.username }}

            <span class="badge bg-light text-muted text-uppercase">
              {{ m.sender_role }}
            </span>

            <span class="text-muted ms-auto">
              {{ m.created_at|date:"M d, Y · H:i" }}
            </span>
          </div>

          <div class="small mt-1" style="white-space: pre-line;">
            {{ m.message }}
          </div>

        </div>
        {% endfor %}
      {% else %}
        <div class="text-muted fst-italic small">
          No messages yet. This discussion is shared between the assigned user and administrators.
        </div>
      {% endif %}

    </div>
  </div>

  <!-- NEW MESSAGE -->
  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        <textarea class="form-control form-control-sm mb-2"
                  name="message"
                  rows="3"
                  placeholder="Write a message for this work item…"
                  required></textarea>

        <div class="d-flex justify-content-end">
          <button class="btn btn-sm btn-primary">
            <i class="fas fa-paper-plane me-1"></i>
            Send
          </button>
        </div>
      </form>
    </div>
  </div>

</div>

{% endblock %}
