<!-- ============================================
     QXDLG MODAL - Floating Chat Panel (IMPROVED)
============================================ -->
<div class="qxdlg-modal-overlay" id="qxdlgDiscussionModal" data-qxdlg-state="closed">
  <div class="qxdlg-modal-container">
    
    <div class="qxdlg-header-bar">
      <div class="qxdlg-header-left">
        <div class="qxdlg-icon-wrap">
          <i class="fas fa-comments"></i>
        </div>

        <div class="qxdlg-title-group">
          <h3 class="qxdlg-title-text" id="qxdlgTitle">
            Discussion
          </h3>
          <span class="qxdlg-subtitle-text" id="qxdlgSubtitle">
            <!-- Assigned user -->
          </span>
        </div>

      </div>
      <button type="button" class="qxdlg-close-btn" data-qxdlg-dismiss>
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="qxdlg-body-wrap">
      <div class="qxdlg-loader-spin" id="qxdlgLoader">
        <div class="qxdlg-spinner">
          <i class="fas fa-circle-notch fa-spin"></i>
        </div>
        <span>Loading messages...</span>
      </div>
      <iframe
        id="qxdlgFrame"
        class="qxdlg-iframe-embed"
        title="Discussion Thread"
        src="">
      </iframe>
    </div>

  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Montserrat Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

<style>
/* ============================================
   QXDLG MODAL STYLES (IMPROVED) - MONTESSRAT FONT
============================================ */
* {
  box-sizing: border-box;
  font-family: "Montserrat", sans-serif !important;
}

.qxdlg-modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"] {
  pointer-events: auto;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"]::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.35);
  backdrop-filter: blur(6px);
  animation: qxdlg-fadein 0.3s ease;
}

.qxdlg-modal-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 440px;
  max-width: calc(100vw - 48px);
  height: 640px;
  max-height: calc(100vh - 48px);
  background: #ffffff;
  border-radius: 24px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 
    0 25px 50px -12px rgba(0, 0, 0, 0.25),
    0 0 0 1px rgba(203, 213, 225, 0.3);
  transform: translateY(100%) scale(0.92);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: auto;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-modal-overlay[data-qxdlg-state="open"] .qxdlg-modal-container {
  transform: translateY(0) scale(1);
  opacity: 1;
}

.qxdlg-header-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  background: linear-gradient(135deg, #8fa6c5 0%, #7ba3c4 50%, #6a92b3 100%);
  color: #ffffff;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(91, 141, 179, 0.15);
  font-family: "Montserrat", sans-serif;
}

.qxdlg-header-left {
  display: flex;
  align-items: center;
  gap: 14px;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-icon-wrap {
  width: 44px;
  height: 44px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.qxdlg-icon-wrap i {
  font-size: 20px;
  color: #ffffff;
}

.qxdlg-title-group {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-title-text {
  font-size: 17px;
  font-weight: 700;
  margin: 0;
  color:#dcdcdc;
  letter-spacing: -0.02em;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-subtitle-text {
  font-size: 12px;
  opacity: 0.9;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-close-btn {
  width: 40px;
  height: 40px;
  border: none;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  transition: all 0.25s ease;
  font-size: 16px;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-close-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: rotate(90deg);
}

.qxdlg-body-wrap {
  flex: 1;
  position: relative;
  background: linear-gradient(135deg, #f0f4f8 0%, #e6eef5 100%);
  overflow: hidden;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-loader-spin {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 18px;
  background: linear-gradient(135deg, #f0f4f8 0%, #e6eef5 100%);
  z-index: 10;
  color: #64748b;
  font-size: 14px;
  font-weight: 600;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-loader-spin[data-qxdlg-hidden="true"] {
  display: none;
}

.qxdlg-spinner {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #7ba3c4;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-spinner i {
  font-size: 40px;
}

.qxdlg-iframe-embed {
  width: 100%;
  height: 100%;
  border: none;
  background: linear-gradient(135deg, #f0f4f8 0%, #e6eef5 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
  font-family: "Montserrat", sans-serif;
}

.qxdlg-iframe-embed[data-qxdlg-loaded="true"] {
  opacity: 1;
}

@keyframes qxdlg-fadein {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Ensure Font Awesome icons maintain their font */
.fa,
.fas,
.far,
.fab,
.fal {
  font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important;
}

/* Ensure all text elements use Montserrat */
h1, h2, h3, h4, h5, h6,
p, span, div,
input, textarea, button,
a, label, select, option {
  font-family: "Montserrat", sans-serif !important;
}

@media (max-width: 480px) {
  .qxdlg-modal-container {
    bottom: 0;
    right: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border-radius: 0;
  }
}
</style>

<script>
(function () {

  /* ===============================
     CORE ELEMENTS
  =============================== */
  const modal = document.getElementById('qxdlgDiscussionModal');
  if (!modal) return;

  const iframe   = modal.querySelector('#qxdlgFrame');
  const loader   = modal.querySelector('#qxdlgLoader');
  const closeBtn = modal.querySelector('[data-qxdlg-dismiss]');
  const titleEl  = modal.querySelector('#qxdlgTitle');
  const subtitleEl = modal.querySelector('#qxdlgSubtitle');

  /* ===============================
     OPEN MODAL
  =============================== */
  function openModal(url, title, subtitle) {
    if (!url) return;

    loader.removeAttribute('data-qxdlg-hidden');
    iframe.removeAttribute('data-qxdlg-loaded');
    iframe.src = url;

    if (titleEl) {
      titleEl.textContent = title || 'Discussion';
    }

    if (subtitleEl) {
      subtitleEl.textContent = subtitle || '';
    }

    modal.setAttribute('data-qxdlg-state', 'open');
    document.body.style.overflow = 'hidden';
  }

  /* ===============================
     CLOSE MODAL
  =============================== */
 function closeModal() {
  modal.setAttribute('data-qxdlg-state', 'closed');
  document.body.style.overflow = '';

  setTimeout(function () {
    iframe.src = '';

    // ðŸ”¥ REFRESH PARENT PAGE
    window.location.reload();
  }, 400);
}


  /* ===============================
     IFRAME LOAD HANDLER
  =============================== */
  iframe.addEventListener('load', function () {
    loader.setAttribute('data-qxdlg-hidden', 'true');
    iframe.setAttribute('data-qxdlg-loaded', 'true');
  });

  /* ===============================
     UI EVENTS
  =============================== */
  closeBtn.addEventListener('click', closeModal);

  modal.addEventListener('click', function (e) {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && modal.getAttribute('data-qxdlg-state') === 'open') {
      closeModal();
    }
  });

  /* ===============================
     TRIGGER BINDING
  =============================== */
  function attachTriggers() {
    document.querySelectorAll('[data-qxdlg-trigger]').forEach(function (trigger) {

      if (trigger.hasAttribute('data-qxdlg-bound')) return;
      trigger.setAttribute('data-qxdlg-bound', 'true');

      trigger.addEventListener('click', function (e) {
        e.preventDefault();

        const url = this.getAttribute('data-qxdlg-url');
        const title = this.getAttribute('data-qxdlg-title');
        const subtitle = this.getAttribute('data-qxdlg-subtitle');

        openModal(url, title, subtitle);
      });
    });
  }

  /* ===============================
     INIT
  =============================== */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachTriggers);
  } else {
    attachTriggers();
  }

  /* ===============================
     GLOBAL API
  =============================== */
  window.qxdlgDiscussion = {
    open: openModal,
    close: closeModal,
    attachTriggers: attachTriggers
  };

})();
</script>