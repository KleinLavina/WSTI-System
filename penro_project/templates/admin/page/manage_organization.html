{% extends "admin/layout/base.html" %}
{% block title %}Manage Organization{% endblock %}
{% block content %}

<div class="org-management-container">

  <!-- =========================
       PAGE HEADER
  ========================== -->
  <div class="header-section">
    <div class="header-content-wrapper">
      <div class="header-title-row">
        <div class="title-section">
          <h3 class="fw-bold mb-0">Organization Structure</h3>
          {% with root_teams=teams|default:None %}
          {% with division_count=teams|length %}
          <span class="org-count-badge">{{ division_count }} Division{% if division_count != 1 %}s{% endif %}</span>
          {% endwith %}
          {% endwith %}
        </div>
        
        <div class="action-buttons">
          <a href="{% url 'admin_app:users' %}" class="btn-action btn-secondary">
            <i class="fas fa-user-friends"></i>
            Manage Users/Focals
          </a>

          <a href="#"
             class="btn-action btn-primary"
             data-bs-toggle="modal"
             data-bs-target="#createTeamModal">
            <i class="fas fa-plus-circle"></i>
            Create Organization Unit
          </a>
        </div>
      </div>
      
      <div class="header-border"></div>
      
      <div class="header-bottom-row">
        <div class="description-section">
          <p class="header-description mb-0">
            <i class="fas fa-info-circle me-2"></i>
            View and manage organizational structures in one place. Add, edit, or remove teams and departments.
          </p>
        </div>
        
        <div class="sort-section">
          <div class="sort-dropdown">
            <span class="sort-label me-2">
              <i class="fas fa-sort-amount-down"></i>
              Sort by:
            </span>
            <select class="form-select form-select-sm" id="orgSortSelect" onchange="applySort(this.value)">
              <option value="type_name" {% if not current_sort or current_sort == "type_name" %}selected{% endif %}>Type & Name</option>
              <option value="name_asc" {% if current_sort == "name_asc" %}selected{% endif %}>Name (A-Z)</option>
              <option value="name_desc" {% if current_sort == "name_desc" %}selected{% endif %}>Name (Z-A)</option>
              <option value="size_desc" {% if current_sort == "size_desc" %}selected{% endif %}>Team Size (High to Low)</option>
              <option value="size_asc" {% if current_sort == "size_asc" %}selected{% endif %}>Team Size (Low to High)</option>
              <option value="date_desc" {% if current_sort == "date_desc" %}selected{% endif %}>Recently Created</option>
              <option value="date_asc" {% if current_sort == "date_asc" %}selected{% endif %}>Oldest First</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       PAGE CONTENT
  ========================== -->
  <div class="content-wrapper">
    {% include "admin/page/includes/manage_organization_content.html" %}
  </div>

</div>

{% include "admin/page/modals/create_team_modal.html" %}
{% include "admin/page/modals/edit_team_modal.html" %}
{% include "admin/page/modals/delete_team_modal.html" %}

<style>
/* =============================
   CUSTOM COLOR VARIABLES
============================= */
:root {
  --primary-dark: #1e3a8a;
  --primary-medium: #2563eb;
  --primary-light: #3b82f6;
  --secondary-dark: #0f172a;
  --secondary-medium: #334155;
  --secondary-light: #64748b;
  --background-light: #f8fafc;
  --border-color: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

/* =============================
   MAIN CONTAINER
============================= */
.org-management-container {
  padding: 1px;
  background-color: var(--background-light);
  min-height: 100vh;
}

/* =============================
   HEADER SECTION
============================= */
.header-section {
  background: white;
  border-radius: 12px;
  box-shadow: var(--shadow-md);
  margin-bottom: 30px;
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.header-content-wrapper {
  padding: 24px;
}

.header-title-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 16px;
}

.title-section {
  display: flex;
  align-items: center;
  gap: 16px;
}

.title-section h3 {
  color: var(--secondary-dark);
  font-size: 1.75rem;
  font-weight: 700;
}

.org-count-badge {
  background: linear-gradient(135deg, #dbeafe, #93c5fd);
  color: #1d4ed8;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 700;
  border: 1px solid #bfdbfe;
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
}

/* =============================
   ACTION BUTTONS
============================= */
.action-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.btn-action {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: none;
  cursor: pointer;
  font-size: 0.9375rem;
  white-space: nowrap;
}

.btn-action.btn-secondary {
  background: white;
  border-radius: 30px;
  color: var(--secondary-medium);
  border: 1.5px solid var(--border-color);
  box-shadow: var(--shadow-sm);
}

.btn-action.btn-secondary:hover {
  background: #f8fafc;
  border-color: var(--primary-medium);
  color: var(--primary-medium);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.btn-action.btn-primary {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary-medium));
  color: white;
  border: none;
  border-radius: 30px;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-action.btn-primary:hover {
  background: linear-gradient(135deg, var(--primary-medium), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
  transform: translateY(-2px);
}

.btn-action i {
  font-size: 1rem;
}

/* =============================
   HEADER BORDER
============================= */
.header-border {
  height: 1px;
  background: black;
  margin: 20px 0;
  width: 100%;
}

/* =============================
   HEADER BOTTOM ROW
============================= */
.header-bottom-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
}

.description-section {
  flex: 1;
  min-width: 300px;
}

.header-description {
  color: var(--secondary-light);
  font-size: 0.95rem;
  line-height: 1.5;
  margin: 0;
  display: flex;
  align-items: flex-start;
}

.header-description i {
  color: var(--primary-medium);
  margin-top: 2px;
}

/* =============================
   SORT SECTION
============================= */
.sort-section {
  display: flex;
  align-items: center;
}

.sort-dropdown {
  display: flex;
  align-items: center;
  background: white;
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid var(--border-color);
  box-shadow: var(--shadow-sm);
}

.sort-label {
  color: var(--secondary-medium);
  font-size: 0.875rem;
  font-weight: 500;
  white-space: nowrap;
}

.sort-label i {
  color: var(--primary-medium);
}

.form-select-sm {
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 6px 32px 6px 12px;
  font-size: 0.875rem;
  color: var(--secondary-dark);
  background-color: white;
  min-width: 180px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.form-select-sm:focus {
  border-color: var(--primary-medium);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  outline: none;
}

.form-select-sm:hover {
  border-color: var(--primary-light);
}



/* =============================
   RESPONSIVE DESIGN
============================= */
@media (max-width: 992px) {
  .header-title-row {
    flex-direction: column;
    align-items: stretch;
  }
  
  .action-buttons {
    justify-content: flex-start;
  }
}

@media (max-width: 768px) {
  .header-content-wrapper {
    padding: 20px;
  }
  
  .header-bottom-row {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }
  
  .description-section {
    min-width: auto;
  }
  
  .sort-section {
    width: 100%;
  }
  
  .sort-dropdown {
    width: 100%;
    justify-content: space-between;
  }
  
  .form-select-sm {
    flex: 1;
    min-width: 0;
  }
}

@media (max-width: 576px) {
  .action-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .btn-action {
    width: 100%;
    justify-content: center;
  }
  
  .title-section {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
}
</style>

<script>
// Function to apply sorting
function applySort(sortValue) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Update sort parameter
    if (sortValue === 'type_name') {
        urlParams.delete('sort');
    } else {
        urlParams.set('sort', sortValue);
    }
    
    // Build new URL
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    
    // Redirect to sorted view
    window.location.href = newUrl;
}

// Function to get total user count for a team (including children)
function getTotalUsers(team) {
    let total = (team.users || []).length;
    
    // Recursively count children's users
    function countChildrenUsers(children) {
        for (const child of children) {
            total += (child.users || []).length;
            if (child.children_list && child.children_list.length > 0) {
                countChildrenUsers(child.children_list);
            }
        }
    }
    
    if (team.children_list && team.children_list.length > 0) {
        countChildrenUsers(team.children_list);
    }
    
    return total;
}

// Function to sort teams based on selected criteria
function sortTeams(teams, sortCriteria) {
    if (!teams) return teams;
    
    switch(sortCriteria) {
        case 'name_asc':
            return teams.sort((a, b) => a.name.localeCompare(b.name));
        case 'name_desc':
            return teams.sort((a, b) => b.name.localeCompare(a.name));
        case 'size_desc':
            return teams.sort((a, b) => getTotalUsers(b) - getTotalUsers(a));
        case 'size_asc':
            return teams.sort((a, b) => getTotalUsers(a) - getTotalUsers(b));
        case 'date_desc':
            return teams.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        case 'date_asc':
            return teams.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        default: // type_name (default)
            return teams.sort((a, b) => {
                // First by team_type (DIVISION, SECTION, etc.)
                const typeOrder = { 'DIVISION': 1, 'SECTION': 2, 'SERVICE': 3, 'UNIT': 4, 'TEAM': 5 };
                const typeA = typeOrder[a.team_type] || 6;
                const typeB = typeOrder[b.team_type] || 6;
                
                if (typeA !== typeB) return typeA - typeB;
                
                // Then by name within same type
                return a.name.localeCompare(b.name);
            });
    }
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Get current sort value from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort') || 'type_name';
    
    // Set the select value
    const sortSelect = document.getElementById('orgSortSelect');
    if (sortSelect) {
        sortSelect.value = currentSort;
    }
    
    console.log('Organization page loaded with sort:', currentSort);
    
    // Note: Server-side sorting is required for initial load
    // Client-side sorting can be implemented if needed for dynamic reordering
});
</script>

{% endblock %}