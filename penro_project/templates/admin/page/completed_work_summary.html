{% extends "admin/layout/base.html" %}
{% block title %}Work Assignment Analytics{% endblock %}

{% block content %}

<!-- HEADER -->
<div class="mb-4 d-flex justify-content-between align-items-start flex-wrap gap-3">

  <div>
    <h3 class="fw-bold d-flex align-items-center gap-2 mb-1">
      <i class="fas fa-chart-bar text-primary"></i>
      Work Assignment Analytics
    </h3>
    <p class="text-muted mb-0">
      Status and review breakdown per active work cycle
    </p>
  </div>

  <!-- VIEW TOGGLE -->
  <div class="btn-group shadow-sm" role="group">
    <button type="button"
            class="btn btn-outline-secondary active"
            id="listViewBtn">
      <i class="fas fa-list"></i>
    </button>
    <button type="button"
            class="btn btn-outline-secondary"
            id="cardViewBtn">
      <i class="fas fa-th-large"></i>
    </button>
  </div>

</div>

{% if summary %}

<!-- ================= LIST VIEW ================= -->
<div id="listView">
  <div class="card shadow-sm">
    <div class="card-body p-0">

      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Work Cycle</th>
            <th>Due Date</th>
            <th>Total</th>
            <th>Done</th>
            <th>Pending Review</th>
            <th>Needs Revision</th>
            <th>Approved</th>
            <th>Approval %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary %}
          <tr>

            <!-- Work Cycle -->
            <td>
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-reset fw-semibold">
                <i class="fas fa-tasks me-1 text-muted"></i>
                {{ row.workcycle__title }}
              </a>
            </td>

            <!-- Due Date -->
            <td>
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-reset text-muted">
                <i class="far fa-calendar-alt me-1"></i>
                {{ row.workcycle__due_at|date:'M d, Y · H:i' }}
              </a>
            </td>

            <td>
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-reset">
                {{ row.total_workers }}
              </a>
            </td>

            <td class="fw-semibold text-success">
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-success">
                {{ row.done_count }}
              </a>
            </td>

            <td class="text-warning">
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-warning">
                {{ row.pending_review_count }}
              </a>
            </td>

            <td class="text-danger">
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-danger">
                {{ row.needs_revision_count }}
              </a>
            </td>

            <td class="fw-semibold text-primary">
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none text-primary">
                {{ row.approved_count }}
              </a>
            </td>

            <td>
              <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
                 class="d-block text-decoration-none">
                <span class="badge bg-primary-subtle text-primary">
                  {{ row.approval_pct|floatformat:1 }}%
                </span>
              </a>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>
</div>

<!-- ================= CARD VIEW (UNCHANGED) ================= -->
<div id="cardView" class="d-none">
  <div class="row g-4">

    {% for row in summary %}
    <div class="col-md-6 col-xl-4">

      <a href="{% url 'admin_app:done-workers-by-workcycle' row.workcycle_id %}"
         class="text-decoration-none text-reset">

        <div class="card ui-card h-100 clickable-card">
          <div class="card-body d-flex flex-column">

            <div class="mb-2">
              <h6 class="fw-semibold mb-1">
                <i class="fas fa-tasks me-1 text-muted"></i>
                {{ row.workcycle__title }}
              </h6>

              <div class="text-muted small">
                <i class="far fa-calendar-alt me-1"></i>
                {{ row.workcycle__due_at|date:'M d, Y · H:i' }}
              </div>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-2">
              <span class="badge bg-secondary-subtle text-secondary">
                Total: {{ row.total_workers }}
              </span>
              <span class="badge bg-success-subtle text-success">
                Done: {{ row.done_count }}
              </span>
              <span class="badge bg-warning-subtle text-warning">
                Pending: {{ row.pending_review_count }}
              </span>
              <span class="badge bg-danger-subtle text-danger">
                Revision: {{ row.needs_revision_count }}
              </span>
              <span class="badge bg-primary-subtle text-primary">
                Approved: {{ row.approved_count }}
              </span>
            </div>

            <div class="mt-auto pt-3">
              <span class="badge bg-primary-subtle text-primary">
                Approval {{ row.approval_pct|floatformat:1 }}%
              </span>
            </div>

          </div>
        </div>

      </a>
    </div>
    {% endfor %}

  </div>
</div>

{% else %}
<div class="p-4 text-muted text-center fst-italic">
  <i class="far fa-folder-open me-1"></i>
  No analytics data available
</div>
{% endif %}

<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const listViewBtn = document.getElementById("listViewBtn");
  const cardViewBtn = document.getElementById("cardViewBtn");
  const listView = document.getElementById("listView");
  const cardView = document.getElementById("cardView");

  listViewBtn.addEventListener("click", () => {
    listView.classList.remove("d-none");
    cardView.classList.add("d-none");
    listViewBtn.classList.add("active");
    cardViewBtn.classList.remove("active");
  });

  cardViewBtn.addEventListener("click", () => {
    cardView.classList.remove("d-none");
    listView.classList.add("d-none");
    cardViewBtn.classList.add("active");
    listViewBtn.classList.remove("active");
  });
});
</script>

{% endblock %}
