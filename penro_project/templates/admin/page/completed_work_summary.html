{% extends "admin/layout/base.html" %}
{% block title %}Work Assignment Analytics{% endblock %}

{% block content %}

<!-- =========================
     HEADER
========================= -->
<div class="mb-4 d-flex justify-content-between align-items-start flex-wrap gap-3">

  <!-- LEFT -->
  <div>
    <h3 class="fw-bold d-flex align-items-center gap-2 mb-1">
      <i class="fas fa-chart-bar text-primary"></i>
      Work Assignment Analytics
      <span class="badge bg-primary bg-opacity-10 text-primary ms-2">
        {{ total_workcycles }}
      </span>
    </h3>

    <p class="text-muted mb-1">
      Status and review breakdown per active work cycle
    </p>
  </div>

  <!-- RIGHT: VIEW TOGGLE -->
  <div class="btn-group shadow-sm" role="group">
    <button type="button"
            class="btn btn-outline-secondary"
            id="listViewBtn"
            title="List view">
      <i class="fas fa-list"></i>
    </button>
    <button type="button"
            class="btn btn-outline-secondary"
            id="cardViewBtn"
            title="Card view">
      <i class="fas fa-th-large"></i>
    </button>
  </div>

</div>

<hr class="wc-header-divider">

<!-- =========================
     CONTENT
========================= -->
{% if summary %}

  <!-- LIST VIEW -->
  <div id="listView">
    {% include "admin/page/_completed_work_list.html" %}
  </div>

  <!-- CARD VIEW -->
  <div id="cardView" class="d-none">
    {% include "admin/page/_completed_work_cards.html" %}
  </div>

{% else %}
  <div class="p-4 text-muted text-center fst-italic">
    <i class="far fa-folder-open me-1"></i>
    No analytics data available
  </div>
{% endif %}

<!-- =========================
     SCRIPTS
========================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const STORAGE_KEY = "completed_work_view";

  const listBtn = document.getElementById("listViewBtn");
  const cardBtn = document.getElementById("cardViewBtn");
  const listView = document.getElementById("listView");
  const cardView = document.getElementById("cardView");

  function showListView(save = true) {
    listView.classList.remove("d-none");
    cardView.classList.add("d-none");
    listBtn.classList.add("active");
    cardBtn.classList.remove("active");
    if (save) localStorage.setItem(STORAGE_KEY, "list");
  }

  function showCardView(save = true) {
    cardView.classList.remove("d-none");
    listView.classList.add("d-none");
    cardBtn.classList.add("active");
    listBtn.classList.remove("active");
    if (save) localStorage.setItem(STORAGE_KEY, "card");
  }

  // Restore preference
  const savedView = localStorage.getItem(STORAGE_KEY);
  if (savedView === "card") {
    showCardView(false);
  } else {
    showListView(false); // default
  }

  // Button handlers
  listBtn.addEventListener("click", () => showListView());
  cardBtn.addEventListener("click", () => showCardView());
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".progressPie").forEach(canvas => {
    const done = Number(canvas.dataset.done || 0);
    const total = Number(canvas.dataset.total || 0);
    const remaining = Math.max(total - done, 0);

    new Chart(canvas, {
      type: "doughnut",
      data: {
        labels: ["Done", "Remaining"],
        datasets: [{
          data: [done, remaining],
          backgroundColor: ["#10b981", "#e5e7eb"],
          borderWidth: 0
        }]
      },
      options: {
        cutout: "70%",
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });
  });
});
</script>

<!-- =========================
     STYLES
========================= -->
<style>
.wc-header-divider {
  margin: 0.875rem 0;
  border: 0;
  border-top: 1px solid #000;
}
</style>

{% endblock %}
