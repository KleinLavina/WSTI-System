{% extends "admin/layout/base.html" %}
{% load static %}

{% block title %}Work Cycles{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/workcycles.css' %}">
{% endblock %}

{% block content %}

<main class="wc-page" role="main">

  <!-- =====================================================
      PAGE HEADER
  ====================================================== -->
  <header class="wc-admin-header" role="banner">

    <section class="wc-header-title-block">
      <h1>
        <i class="fas fa-layer-group" aria-hidden="true"></i>
        Work Cycles
        <span class="wc-header-count-badge">
          {{ workcycles|length }}
        </span>
      </h1>

      <p class="wc-header-subtitle">
        TIWI Reference · Task Management & Deadline Tracking
      </p>
    </section>

    <nav class="wc-header-actions" aria-label="Header actions">
      <button
        type="button"
        class="btn-wc-link"
        data-bs-toggle="modal"
        data-bs-target="#workcyclePurposeModal">
        <i class="fas fa-info-circle"></i>
        What is a Work Cycle?
      </button>

      <a
        href="{% url 'admin_app:inactive-workcycles' %}"
        class="btn-wc-secondary"
        aria-label="View archived work cycles">
        <i class="fas fa-archive" aria-hidden="true"></i>
        Archived Work Cycles
      </a>

      <button
        type="button"
        class="btn-wc-success"
        data-bs-toggle="modal"
        data-bs-target="#createWorkcycleModal">
        <span class="btn-icon">+</span>
        Create New Cycle
      </button>
    </nav>

  </header>

  <hr class="wc-header-divider">

  <!-- =====================================================
      STATS + FILTERS
  ====================================================== -->
  <section class="wc-stats-filter-row">

    <!-- STATS -->
    <div class="wc-stats-section">
      <aside class="wc-stats-container" aria-label="Work cycle statistics">
        <h1>
          <i class="fas fa-filter"></i> Filter By:
        </h1>

        <div class="wc-stats-badges">

          <a href="{% url 'admin_app:workcycles' %}"
             class="wc-badge wc-badge-active {% if not current_state %}is-selected{% endif %}">
            <i class="fas fa-check-circle"></i>
            Total Active: {{ active_count }}
          </a>

          <a href="?state=ongoing"
             class="wc-badge wc-badge-ongoing {% if current_state == 'ongoing' %}is-selected{% endif %}">
            <i class="fas fa-sync-alt"></i>
            {{ lifecycle_counts.ongoing }} Ongoing
          </a>

          <a href="?state=due_soon"
             class="wc-badge wc-badge-due-soon {% if current_state == 'due_soon' %}is-selected{% endif %}">
            <i class="fas fa-hourglass-half"></i>
            {{ lifecycle_counts.due_soon }} Due Soon
          </a>

          <a href="?state=lapsed"
             class="wc-badge wc-badge-lapsed {% if current_state == 'lapsed' %}is-selected{% endif %}">
            <i class="fas fa-exclamation-triangle"></i>
            {{ lifecycle_counts.lapsed }} Lapsed
          </a>

        </div>
      </aside>
    </div>

    <!-- SEARCH -->
    <div class="wc-search-section">
      <form method="get"
            action="{% url 'admin_app:workcycles' %}"
            class="wc-filter-form"
            role="search">

        <article class="wc-filter-card wc-search-card">
          <label class="wc-filter-label">
            <i class="fas fa-search"></i> Search
          </label>

          <div class="wc-search-input-wrapper">
            <input type="search"
                   name="q"
                   value="{{ search_query }}"
                   class="wc-filter-input"
                   placeholder="Search…">
            <button type="submit" class="btn-wc-primary">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </article>

      </form>
    </div>

  </section>

  <!-- =====================================================
      CONTENT (INCLUDED)
  ====================================================== -->
  <section class="wc-content-area">
    {% include "admin/page/_workcycle_cards.html" %}
  </section>

</main>

<!-- =====================================================
    MODALS
====================================================== -->
{% include "admin/page/modals/workcycle_purpose_modal.html" %}
{% include "admin/page/modals/create_workcycle_modal.html" %}
{% include "admin/page/modals/edit_workcycle_modal.html" %}
{% include "admin/page/modals/delete_workcycles_modal.html" %}
{% include "admin/page/modals/reassign_workcycle_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

  const cards = document.querySelectorAll('.wc-card');

  cards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.zIndex = '10';
    });

    card.addEventListener('mouseleave', function() {
      this.style.zIndex = '1';
    });
  });

  cards.forEach(card => {
    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        const link = this.querySelector('.wc-dropdown-item');
        if (link) {
          e.preventDefault();
          link.click();
        }
      }
    });
  });

  const editModal = document.getElementById('editWorkcycleModal');
  if (editModal) {
    editModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      this.querySelector('#edit_workcycle_id').value = button.dataset.id;
      this.querySelector('#edit_title').value = button.dataset.title;
      this.querySelector('#edit_description').value = button.dataset.description;
      this.querySelector('#edit_due_at').value = button.dataset.due;
    });
  }

  const reassignModal = document.getElementById('reassignWorkcycleModal');
  if (reassignModal) {
    reassignModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      this.querySelector('#reassign_workcycle_id').value = button.dataset.id;
      this.querySelector('#reassign_workcycle_title').textContent = button.dataset.title;
    });
  }
});

document.addEventListener("DOMContentLoaded", function () {
  const deleteModal = document.getElementById("deleteWorkcycleModal");
  if (!deleteModal) return;

  deleteModal.addEventListener("show.bs.modal", function (event) {
    const deleteUrl = event.relatedTarget.getAttribute("data-delete-url");
    deleteModal.querySelector("#deleteWorkcycleForm").action = deleteUrl;
  });
});
</script>
{% endblock %}
