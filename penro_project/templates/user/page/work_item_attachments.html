{% extends "user/layout/base.html" %}

{% block title %}
{{ attachment_label }}
{% endblock %}

{% block content %}

<style>
/* =====================================================
   SOFT COLOR PALETTE
===================================================== */
:root {
  /* Soft Neutrals */
  --soft-white: #ffffff;
  --soft-bg: #f8fafc;
  --soft-bg-alt: #f1f5f9;
  --soft-border: #e2e8f0;
  --soft-border-light: #e2e8f0;
  
  /* Soft Text Colors */
  --soft-text-primary: #1e293b;
  --soft-text-secondary: #475569;
  --soft-text-tertiary: #64748b;
  --soft-text-muted: #94a3b8;
  
  /* Soft Accents */
  --soft-blue: #3b82f6;
  --soft-blue-light: #dbeafe;
  --soft-green: #10b981;
  --soft-green-light: #d1fae5;
  --soft-amber: #f59e0b;
  --soft-amber-light: #fef3c7;
  --soft-red: #ef4444;
  --soft-red-light: #fee2e2;
  --soft-violet: #8b5cf6;
  --soft-violet-light: #ede9fe;
  
  /* Soft Shadows */
  --soft-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --soft-shadow-md: 0 1px 3px rgba(0, 0, 0, 0.1);
  --soft-shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.05);
}

/* =====================================================
   PAGE CONTAINER
===================================================== */
.attachments-page {
  background: var(--soft-bg);
  min-height: 100vh;
  padding: 1rem;
  max-width: 1000px;
  margin: 0 auto;
}

/* =====================================================
   BACK LINK
===================================================== */
.back-link-soft {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--soft-text-secondary);
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.15s ease;
  margin-bottom: 1.5rem;
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  box-shadow: var(--soft-shadow-sm);
}

.back-link-soft:hover {
  background: var(--soft-bg-alt);
  color: var(--soft-blue);
  border-color: var(--soft-blue);
  transform: translateX(-2px);
  text-decoration: none;
}

.back-link-soft i {
  font-size: 0.85rem;
}

/* =====================================================
   PAGE HEADER
===================================================== */
.page-header-soft {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  padding: 1.25rem 1.5rem;
  background: var(--soft-white);
  border-radius: 12px;
  border: 1px solid var(--soft-border);
  box-shadow: var(--soft-shadow-md);
}

.page-header-soft i {
  font-size: 1.5rem;
  color: var(--soft-blue);
}

.page-header-soft h5 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--soft-text-primary);
}

/* =====================================================
   CARD DESIGN
===================================================== */
.card-soft {
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 12px;
  box-shadow: var(--soft-shadow-sm);
  margin-bottom: 1.5rem;
  overflow: hidden;
  transition: box-shadow 0.2s ease;
}

.card-soft:hover {
  box-shadow: var(--soft-shadow-md);
}

.card-header-soft {
  padding: 1.25rem 1.5rem;
  background: linear-gradient(135deg, var(--soft-bg-alt), var(--soft-bg));
  border-bottom: 1px solid var(--soft-border);
}

.card-header-title-soft {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--soft-text-primary);
}

.card-header-title-soft i {
  font-size: 1.1rem;
  color: var(--soft-blue);
}

.card-body-soft {
  padding: 1.5rem;
  background: var(--soft-white);
}

/* =====================================================
   ATTACHMENT GROUPS
===================================================== */
.attachment-group-soft {
  margin-bottom: 1.5rem;
}

.attachment-group-soft:last-child {
  margin-bottom: 0;
}

.attachment-group-title-soft {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding: 0.5rem 0.75rem;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--soft-text-primary);
  background: var(--soft-bg-alt);
  border-radius: 8px;
  border-left: 3px solid var(--soft-blue);
}

.attachment-group-title-soft i {
  color: var(--soft-blue);
  font-size: 0.9rem;
}

/* =====================================================
   FILE LIST
===================================================== */
.file-list-soft {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin: 0;
  padding: 0;
  list-style: none;
}

.file-item-soft {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.9rem 1.1rem;
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 10px;
  transition: all 0.15s ease;
}

.file-item-soft:hover {
  background: var(--soft-bg-alt);
  border-color: var(--soft-blue);
  transform: translateY(-1px);
  box-shadow: var(--soft-shadow-sm);
}

.file-link-soft {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  font-size: 0.875rem;
  color: var(--soft-text-primary);
  text-decoration: none;
  font-weight: 500;
  transition: color 0.15s ease;
}

.file-link-soft:hover {
  color: var(--soft-blue);
  text-decoration: none;
}

.file-link-soft i {
  font-size: 1rem;
  color: var(--soft-blue);
}

.file-date-soft {
  font-size: 0.8rem;
  color: var(--soft-text-tertiary);
  font-weight: 500;
}

/* =====================================================
   DELETE BUTTON
===================================================== */
.btn-delete-soft {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  color: var(--soft-red);
  background: var(--soft-white);
  border: 1px solid var(--soft-red-light);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.btn-delete-soft:hover {
  background: var(--soft-red-light);
  color: #dc2626;
}

.btn-delete-soft i {
  font-size: 0.75rem;
}

/* =====================================================
   EMPTY STATE
===================================================== */
.empty-state-soft {
  padding: 2rem;
  text-align: center;
  color: var(--soft-text-tertiary);
  font-style: italic;
  background: var(--soft-bg);
  border: 2px dashed var(--soft-border);
  border-radius: 10px;
}

.empty-state-soft i {
  font-size: 2.5rem;
  color: var(--soft-text-muted);
  margin-bottom: 0.75rem;
  display: block;
}

/* =====================================================
   DROPZONE
===================================================== */
.dropzone-soft {
  position: relative;
  border: 2px dashed var(--soft-border);
  border-radius: 12px;
  padding: 2.5rem 2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  background: var(--soft-white);
  text-align: center;
}

.dropzone-soft:hover {
  background: var(--soft-blue-light);
  border-color: var(--soft-blue);
}

.dropzone-soft.dragover {
  background: var(--soft-blue-light);
  border-color: var(--soft-blue);
  border-width: 2px;
  transform: scale(1.01);
}

.dropzone-icon-soft {
  font-size: 2.5rem;
  color: var(--soft-blue);
  margin-bottom: 1rem;
  display: block;
}

.dropzone-title-soft {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--soft-text-primary);
  margin-bottom: 0.4rem;
}

.dropzone-subtitle-soft {
  font-size: 0.875rem;
  color: var(--soft-text-secondary);
  margin-bottom: 1.25rem;
}

.choose-files-btn-soft {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1.5rem;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--soft-white);
  background: var(--soft-blue);
  border: none;
  border-radius: 8px;
  transition: all 0.15s ease;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
}

.choose-files-btn-soft:hover {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.choose-files-btn-soft i {
  font-size: 0.9rem;
}

/* =====================================================
   SELECTED FILES LIST
===================================================== */
.selected-files-container-soft {
  margin: 1.25rem 0;
}

.selected-files-header-soft {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding: 0.5rem 0.75rem;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--soft-text-primary);
  background: var(--soft-bg-alt);
  border-radius: 8px;
  border-left: 3px solid var(--soft-blue);
}

.selected-files-header-soft i {
  color: var(--soft-blue);
  font-size: 0.95rem;
}

.selected-files-list-soft {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.selected-file-item-soft {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.85rem 1rem;
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 8px;
  transition: all 0.15s ease;
}

.selected-file-item-soft:hover {
  background: var(--soft-bg-alt);
  border-color: var(--soft-border-light);
}

.selected-file-info-soft {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  font-size: 0.875rem;
  color: var(--soft-text-primary);
}

.selected-file-info-soft i {
  color: var(--soft-blue);
  font-size: 1rem;
}

.file-size-soft {
  color: var(--soft-text-tertiary);
  font-size: 0.8rem;
}

.remove-file-btn-soft {
  padding: 0.25rem 0.5rem;
  font-size: 1rem;
  line-height: 1;
  color: var(--soft-text-muted);
  background: none;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.remove-file-btn-soft:hover {
  color: var(--soft-red);
  background: var(--soft-red-light);
}

/* =====================================================
   UPLOAD BUTTON
===================================================== */
.upload-btn-soft {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.75rem;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--soft-white);
  background: var(--soft-green);
  border: none;
  border-radius: 10px;
  transition: all 0.15s ease;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
}

.upload-btn-soft:hover {
  background: #059669;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.upload-btn-soft i {
  font-size: 0.95rem;
}

.upload-btn-soft:disabled {
  background: var(--soft-border);
  color: var(--soft-text-muted);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* =====================================================
   ERROR MESSAGES
===================================================== */
.error-container-soft {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 2000;
  max-width: 400px;
  width: 90%;
}

.error-alert-soft {
  background: var(--soft-red);
  color: var(--soft-white);
  padding: 1rem;
  border-radius: 8px;
  box-shadow: var(--soft-shadow-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  animation: slideInSoft 0.3s ease-out;
  position: relative;
  overflow: hidden;
}

.error-alert-soft i.fa-exclamation-circle {
  font-size: 1.25rem;
  flex-shrink: 0;
}

.error-alert-soft span {
  word-break: break-word;
}

.error-alert-soft button {
  background: none;
  border: none;
  color: var(--soft-white);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 0 0.5rem;
  flex-shrink: 0;
  margin-left: 0.5rem;
}

.progress-bar-soft {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: rgba(255, 255, 255, 0.3);
  width: 100%;
  border-radius: 0 0 8px 8px;
  overflow: hidden;
}

.progress-soft {
  height: 100%;
  background: var(--soft-white);
  width: 100%;
  animation: progressSoft 5s linear forwards;
}

@keyframes slideInSoft {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes fadeOutSoft {
  to {
    opacity: 0;
    transform: translateY(-20px);
  }
}

@keyframes progressSoft {
  from { width: 100%; }
  to { width: 0%; }
}

/* =====================================================
   RESPONSIVE DESIGN
===================================================== */
@media (max-width: 768px) {
  .attachments-page {
    padding: 0.75rem;
  }
  
  .page-header-soft {
    padding: 1rem 1.25rem;
  }
  
  .card-header-soft,
  .card-body-soft {
    padding: 1rem 1.25rem;
  }
  
  .dropzone-soft {
    padding: 2rem 1.5rem;
  }
  
  .file-item-soft {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .error-container-soft {
    right: 10px;
    left: 10px;
    max-width: none;
    width: auto;
  }
}
</style>

<div class="attachments-page">
  {% if messages %}
  <div class="error-container-soft">
    {% for message in messages %}
      {% if message.tags == 'error' %}
      <div class="error-alert-soft">
        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ message }}</span>
        </div>
        <button onclick="this.closest('.error-alert-soft').remove()">
          <i class="fas fa-times"></i>
        </button>
        <div class="progress-bar-soft">
          <div class="progress-soft"></div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.error-alert-soft');
    alerts.forEach(alert => {
      setTimeout(() => {
        alert.style.animation = 'fadeOutSoft 0.3s ease-out forwards';
        setTimeout(() => alert.remove(), 300);
      }, 5000);
      
      alert.addEventListener('mouseenter', function() {
        const progress = this.querySelector('.progress-soft');
        if (progress) {
          progress.style.animationPlayState = 'paused';
        }
      });
      
      alert.addEventListener('mouseleave', function() {
        const progress = this.querySelector('.progress-soft');
        if (progress) {
          progress.style.animationPlayState = 'running';
        }
      });
    });
  });
  </script>
  {% endif %}

  <!-- ================= BACK LINK ================= -->
  <a href="{% url 'user_app:work-item-detail' work_item.id %}" class="back-link-soft">
    <i class="fas fa-arrow-left"></i>
    <span>Back to Work Item</span>
  </a>

  <!-- ================= PAGE HEADER ================= -->
  <div class="page-header-soft">
    <i class="fas fa-paperclip"></i>
    <h5>{{ attachment_label }}</h5>
  </div>

  <!-- ================= ATTACHMENTS CARD ================= -->
  <div class="card-soft">
    <!-- HEADER -->
    <div class="card-header-soft">
      <div class="card-header-title-soft">
        <i class="fas fa-file-archive"></i>
        <span>Uploaded Files</span>
      </div>
    </div>

    <!-- BODY -->
    <div class="card-body-soft">
      {% if attachments %}
        {% regroup attachments by attachment_type as grouped_attachments %}

        {% for group in grouped_attachments %}
          <div class="attachment-group-soft">
            <div class="attachment-group-title-soft">
              {% if group.grouper == "matrix_a" %}
                <i class="fas fa-table"></i>
                Monthly Report Form – Matrix A
              {% elif group.grouper == "matrix_b" %}
                <i class="fas fa-table"></i>
                Monthly Report Form – Matrix B
              {% elif group.grouper == "mov" %}
                <i class="fas fa-check-circle"></i>
                Means of Verification (MOV)
              {% endif %}
            </div>

            <ul class="file-list-soft">
              {% for f in group.list %}
                <li class="file-item-soft">
                  <a href="{{ f.file.url }}" download class="file-link-soft">
                    <i class="far fa-file"></i>
                    <span>{{ f.file.name|slice:"-35:" }}</span>
                  </a>

                  <div class="d-flex align-items-center gap-2">
                    <span class="file-date-soft">
                      {{ f.uploaded_at|date:"M d, Y · h:i A" }}
                    </span>

                    {% if work_item.review_decision != "approved" %}
                    <form method="post"
                          action="{% url 'user_app:delete-attachment' f.id %}"
                          onsubmit="return confirm('Delete this file?');">
                      {% csrf_token %}
                      <button type="submit"
                              class="btn-delete-soft">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}

      {% else %}
        <div class="empty-state-soft">
          <i class="fas fa-folder-open"></i>
          <div>No attachments uploaded yet.</div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ================= UPLOAD CARD ================= -->
  <div class="card-soft">
    <div class="card-header-soft">
      <div class="card-header-title-soft">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>Upload Files</span>
      </div>
    </div>

    <div class="card-body-soft">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_attachment">
        <input type="hidden" name="attachment_type" value="{{ attachment_type }}">

        <input type="file"
               id="attachmentInput"
               name="attachments"
               multiple
               hidden>

        <div id="dropArea" class="dropzone-soft">
          <i class="fas fa-cloud-upload-alt dropzone-icon-soft"></i>
          <p class="dropzone-title-soft">Drag & drop files here</p>
          <p class="dropzone-subtitle-soft">or click the button below to choose files</p>
          <button type="button"
                  id="chooseFilesBtn"
                  class="choose-files-btn-soft">
            <i class="fas fa-folder-open"></i>
            Choose Files
          </button>
        </div>

        <div id="fileListContainer" class="selected-files-container-soft" style="display: none;">
          <div class="selected-files-header-soft">
            <i class="fas fa-folder"></i>
            <span>Files ready to upload (<span id="fileCount">0</span>)</span>
          </div>
          <ul id="fileList" class="selected-files-list-soft"></ul>
        </div>

        <button type="submit" class="upload-btn-soft" disabled>
          <i class="fas fa-upload"></i>
          <span>Upload Files</span>
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const dropArea = document.getElementById("dropArea");
  const input = document.getElementById("attachmentInput");
  const fileList = document.getElementById("fileList");
  const fileListContainer = document.getElementById("fileListContainer");
  const fileCount = document.getElementById("fileCount");
  const chooseBtn = document.getElementById("chooseFilesBtn");
  const uploadBtn = document.querySelector(".upload-btn-soft");

  const dataTransfer = new DataTransfer();

  /* ======================
     CLICK & DRAG EVENTS
  ====================== */

  dropArea.addEventListener("click", () => input.click());

  chooseBtn.addEventListener("click", e => {
    e.stopPropagation();
    input.click();
  });

  dropArea.addEventListener("dragover", e => {
    e.preventDefault();
    dropArea.classList.add("dragover");
  });

  dropArea.addEventListener("dragleave", () => {
    dropArea.classList.remove("dragover");
  });

  dropArea.addEventListener("drop", e => {
    e.preventDefault();
    dropArea.classList.remove("dragover");
    addFiles(e.dataTransfer.files);
  });

  input.addEventListener("change", () => {
    addFiles(input.files);
  });

  /* ======================
     FILE HANDLING
  ====================== */

  function addFiles(files) {
    for (const file of files) {
      const exists = [...dataTransfer.files].some(
        f => f.name === file.name && f.size === file.size
      );
      if (!exists) {
        dataTransfer.items.add(file);
      }
    }

    input.files = dataTransfer.files;
    renderFiles();
  }

  function renderFiles() {
    fileList.innerHTML = "";
    const count = dataTransfer.files.length;

    // Update counter
    fileCount.textContent = count;

    // Toggle UI
    if (count === 0) {
      fileListContainer.style.display = "none";
      uploadBtn.disabled = true;
      return;
    }

    fileListContainer.style.display = "block";
    uploadBtn.disabled = false;

    [...dataTransfer.files].forEach((file, index) => {
      const li = document.createElement("li");
      li.className = "selected-file-item-soft";

      li.innerHTML = `
        <span class="selected-file-info-soft">
          <i class="far fa-file"></i>
          <span>${file.name}</span>
          <span class="file-size-soft">
            (${(file.size / 1024 / 1024).toFixed(2)} MB)
          </span>
        </span>
        <button type="button"
                class="remove-file-btn-soft"
                title="Remove file">
          <i class="fas fa-times"></i>
        </button>
      `;

      li.querySelector(".remove-file-btn-soft")
        .addEventListener("click", () => removeFile(index));

      fileList.appendChild(li);
    });
  }

  function removeFile(index) {
    const files = [...dataTransfer.files];
    dataTransfer.items.clear();

    files.forEach((file, i) => {
      if (i !== index) dataTransfer.items.add(file);
    });

    input.files = dataTransfer.files;
    renderFiles();
  }

  // Init state
  renderFiles();
});
</script>

{% endblock %}