{% extends "user/layout/base.html" %}

{% block title %}
{{ work_item.workcycle.title }} - Details
{% endblock %}

{% block content %}
{% include "admin/page/modals/message_ui_modal.html" %}

<style>
/* =====================================================
   SOFT COLOR PALETTE
===================================================== */
:root {
  /* Soft Neutrals */
  --soft-white: #ffffff;
  --soft-bg: #f8fafc;
  --soft-border: #e2e8f0;
  --soft-border-light: #f1f5f9;
  
  /* Soft Text Colors */
  --soft-text-primary: #1e293b;
  --soft-text-secondary: #475569;
  --soft-text-tertiary: #64748b;
  --soft-text-muted: #94a3b8;
  
  /* Soft Accents */
  --soft-blue: #3b82f6;
  --soft-blue-light: #dbeafe;
  --soft-green: #10b981;
  --soft-green-light: #d1fae5;
  --soft-amber: #f59e0b;
  --soft-amber-light: #fef3c7;
  --soft-red: #ef4444;
  --soft-red-light: #fee2e2;
  --soft-violet: #8b5cf6;
  --soft-violet-light: #ede9fe;
  --soft-cyan: #06b6d4;
  --soft-cyan-light: #cffafe;
  
  /* Soft Shadows */
  --soft-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --soft-shadow-md: 0 1px 3px rgba(0, 0, 0, 0.1);
  --soft-shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.05);
}

/* =====================================================
   COMPACT PAGE LAYOUT
===================================================== */
.work-item-page {
  background: var(--soft-bg);
  min-height: 100vh;
  padding: 1rem;
  max-width: 1200px;
  margin: 0 auto;
}

/* =====================================================
   COMPACT HEADER
===================================================== */
.header-compact {
  background: var(--soft-white);
  border-radius: 12px;
  padding: 1.25rem;
  margin-bottom: 1.25rem;
  box-shadow: var(--soft-shadow-md);
  border: 1px solid var(--soft-border);
  position: relative;
}

.header-top-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--soft-border-light);
}

.header-title-section {
  flex: 1;
  padding-right: 1rem;
}

.header-title {
  color: var(--soft-text-primary);
  font-weight: 600;
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.625rem;
  line-height: 1.3;
}

.header-title i {
  color: var(--soft-blue);
  font-size: 1.125rem;
}

.header-meta-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--soft-text-secondary);
  font-size: 0.8125rem;
}

.header-meta-row i {
  color: var(--soft-amber);
  font-size: 0.875rem;
}

/* Right-side action buttons */
.header-actions {
  display: flex;
  gap: 0.5rem;
  flex-shrink: 0;
}

.action-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
  border-radius: 8px;
  font-size: 0.8125rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.15s ease;
  border: 1px solid;
  background: var(--soft-white);
}

.action-btn-primary {
  border-color: var(--soft-blue-light);
  color: var(--soft-blue);
  background: var(--soft-blue-light);
}

.action-btn-primary:hover {
  background: var(--soft-blue);
  color: var(--soft-white);
  border-color: var(--soft-blue);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.action-btn-secondary {
  border-color: var(--soft-border);
  color: var(--soft-text-secondary);
}

.action-btn-secondary:hover {
  border-color: var(--soft-text-muted);
  background: var(--soft-bg);
  color: var(--soft-text-primary);
  transform: translateY(-1px);
}

.action-btn i {
  font-size: 0.75rem;
}

/* Header bottom section */
.header-bottom-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 0.75rem;
  border-top: 1px solid var(--soft-border-light);
}

.header-description {
  color: var(--soft-text-secondary);
  font-size: 0.875rem;
  line-height: 1.5;
  flex: 1;
  margin: 0;
}

.header-due {
  font-size: 0.8125rem;
  color: var(--soft-text-tertiary);
  background: var(--soft-bg);
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  border: 1px solid var(--soft-border);
  white-space: nowrap;
  margin-left: 1rem;
}

/* =====================================================
   COMPACT MAIN GRID
===================================================== */
.main-grid-compact {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .main-grid-compact {
    grid-template-columns: 1fr;
  }
}

/* =====================================================
   COMPACT PANEL CARDS
===================================================== */
.panel-compact {
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: var(--soft-shadow-sm);
  height: 100%;
  display: flex;
  flex-direction: column;
}

.panel-header-compact {
  padding: 0.875rem 1rem;
  background: var(--soft-bg);
  border-bottom: 1px solid var(--soft-border);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: var(--soft-text-primary);
  font-size: 0.875rem;
}

.panel-header-compact i {
  font-size: 0.875rem;
}

.panel-body-compact {
  padding: 1rem;
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* =====================================================
   COMPACT STATUS SECTION
===================================================== */
.status-section-compact {
  margin-bottom: 1.25rem;
}

.section-label-compact {
  color: var(--soft-text-secondary);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.625rem;
  font-weight: 600;
}

/* Status indicator */
.status-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.625rem 0.75rem;
  background: var(--soft-bg);
  border: 1px solid var(--soft-border);
  border-radius: 8px;
  margin-bottom: 0.875rem;
  font-size: 0.8125rem;
}

.status-indicator i {
  color: var(--soft-cyan);
  font-size: 0.75rem;
}

.status-indicator span {
  color: var(--soft-text-secondary);
}

/* Status buttons */
.status-toggle-compact {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.status-btn-compact {
  flex: 1;
  padding: 0.75rem 0.5rem;
  border: 1px solid var(--soft-border);
  background: var(--soft-white);
  color: var(--soft-text-secondary);
  border-radius: 8px;
  font-size: 0.8125rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  text-align: center;
}

.status-btn-compact:hover {
  border-color: var(--soft-blue);
  color: var(--soft-blue);
  background: var(--soft-blue-light);
  transform: translateY(-1px);
}

.status-btn-compact.active-not-started {
  background: var(--soft-bg);
  border-color: var(--soft-text-tertiary);
  color: var(--soft-text-primary);
}

.status-btn-compact.active-progress {
  background: var(--soft-amber-light);
  border-color: var(--soft-amber);
  color: var(--soft-text-primary);
}

.status-btn-compact i {
  font-size: 0.875rem;
}

.status-btn-compact i.spin {
  animation: spin 1.5s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Completed alert */
.completed-alert-compact {
  background: var(--soft-green-light);
  color: var(--soft-text-primary);
  padding: 0.875rem 1rem;
  border-radius: 8px;
  border: 1px solid var(--soft-green);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.875rem;
  font-weight: 500;
}

.completed-alert-compact i {
  color: var(--soft-green);
  font-size: 0.875rem;
}

.btn-undo-compact {
  background: var(--soft-red);
  color: var(--soft-white);
  border: none;
  border-radius: 6px;
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.btn-undo-compact:hover {
  background: #dc2626;
  transform: translateY(-1px);
}

.btn-undo-compact i {
  font-size: 0.75rem;
}

/* =====================================================
   COMPACT META SECTION
===================================================== */
.meta-section-compact {
  background: var(--soft-bg);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.25rem;
}

.meta-row-compact {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--soft-border-light);
  font-size: 0.8125rem;
}

.meta-row-compact:last-child {
  border-bottom: none;
}

.meta-label-compact {
  color: var(--soft-text-tertiary);
}

.meta-value-compact {
  font-weight: 500;
  color: var(--soft-text-primary);
  display: flex;
  align-items: center;
  gap: 0.375rem;
}

/* Badges */
.badge-status-compact {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.6875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.badge-approved {
  background: var(--soft-green-light);
  color: var(--soft-green);
  border: 1px solid var(--soft-green);
}

.badge-revision {
  background: var(--soft-red-light);
  color: var(--soft-red);
  border: 1px solid var(--soft-red);
}

.badge-pending {
  background: var(--soft-cyan-light);
  color: var(--soft-cyan);
  border: 1px solid var(--soft-cyan);
}

/* =====================================================
   COMPACT SUBMIT SECTION
===================================================== */
.submit-section-compact {
  margin-top: auto;
  padding-top: 1rem;
  border-top: 1px solid var(--soft-border);
}

.btn-submit-compact {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--soft-green);
  border: none;
  border-radius: 8px;
  color: var(--soft-white);
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-submit-compact:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3);
}

.btn-submit-compact:disabled {
  background: var(--soft-border);
  color: var(--soft-text-muted);
  cursor: not-allowed;
}

.submit-hint-compact {
  color: var(--soft-text-tertiary);
  font-size: 0.75rem;
  text-align: center;
  margin-top: 0.5rem;
}

/* =====================================================
   COMPACT NOTES FORM
===================================================== */
.form-group-compact {
  margin-bottom: 1rem;
}

.form-label-compact {
  color: var(--soft-text-secondary);
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 0.375rem;
  display: block;
}

.form-input-compact {
  width: 100%;
  padding: 0.625rem 0.75rem;
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 6px;
  color: var(--soft-text-primary);
  font-size: 0.8125rem;
  transition: all 0.15s ease;
}

.form-input-compact:focus {
  outline: none;
  border-color: var(--soft-blue);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input-compact::placeholder {
  color: var(--soft-text-muted);
}

textarea.form-input-compact {
  resize: vertical;
  min-height: 80px;
}

/* Status chips */
.chips-container-compact {
  display: flex;
  flex-wrap: wrap;
  gap: 0.375rem;
  margin-top: 0.5rem;
}

.status-chip-compact {
  padding: 0.375rem 0.625rem;
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 16px;
  color: var(--soft-text-secondary);
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
}

.status-chip-compact:hover {
  background: var(--soft-bg);
  border-color: var(--soft-blue);
  color: var(--soft-blue);
}

.btn-save-compact {
  padding: 0.625rem 1rem;
  background: var(--soft-blue);
  border: none;
  border-radius: 6px;
  color: var(--soft-white);
  font-weight: 600;
  font-size: 0.8125rem;
  cursor: pointer;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
}

.btn-save-compact:hover {
  background: #2563eb;
  transform: translateY(-1px);
}

/* =====================================================
   COMPACT ATTACHMENTS
===================================================== */
.attachments-section-compact {
  margin-top: 1.5rem;
}

.section-title-compact {
  color: var(--soft-text-primary);
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.375rem;
}

.section-title-compact i {
  color: var(--soft-violet);
  font-size: 0.875rem;
}

.attachments-grid-compact {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.75rem;
}

@media (max-width: 640px) {
  .attachments-grid-compact {
    grid-template-columns: 1fr;
  }
}

.attachment-card-compact {
  background: var(--soft-white);
  border: 1px solid var(--soft-border);
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  text-decoration: none;
  transition: all 0.15s ease;
  display: block;
}

.attachment-card-compact:hover {
  border-color: var(--soft-blue);
  transform: translateY(-2px);
  box-shadow: var(--soft-shadow-md);
}

.attachment-icon-compact {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.attachment-icon-compact.uploaded {
  color: var(--soft-green);
}

.attachment-icon-compact.pending {
  color: var(--soft-text-muted);
}

.attachment-title-compact {
  color: var(--soft-text-primary);
  font-weight: 500;
  font-size: 0.8125rem;
  margin-bottom: 0.5rem;
}

.badge-compact {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.6875rem;
  font-weight: 600;
}

.badge-uploaded-compact {
  background: var(--soft-green-light);
  color: var(--soft-green);
}

.badge-not-uploaded-compact {
  background: var(--soft-bg);
  color: var(--soft-text-tertiary);
}

/* =====================================================
   MODAL HIDDEN STATE
===================================================== */
.qxdlg-modal-overlay[data-qxdlg-state="closed"] {
  display: none;
}
</style>

<div class="work-item-page">
  <!-- Compact Header -->
  <div class="header-compact">
    <!-- Top Row: Title + Actions (right corner) -->
    <div class="header-top-row">
      <div class="header-title-section">
        <h1 class="header-title">
          <i class="fas fa-layer-group"></i>
          {{ work_item.workcycle.title }}
        </h1>
        <div class="header-meta-row">
          <i class="far fa-user-circle"></i>
          <span>Assigned to {{ request.user.get_full_name|default:request.user.username }}</span>
        </div>
      </div>
      
      <!-- Right-side action buttons -->
      <div class="header-actions">
        <a href="#"
           class="action-btn action-btn-primary"
           data-qxdlg-trigger
           data-qxdlg-url="{% url 'user_app:work-item-discussion' work_item.id %}"
           data-qxdlg-title="{{ work_item.workcycle.title }}"
           data-qxdlg-subtitle="Discussion">
          <i class="fas fa-comment-dots"></i>
          <span>Discussion</span>
        </a>
        
        <a href="{% url 'user_app:work-items' %}"
           class="action-btn action-btn-secondary">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
      </div>
    </div>
    
    <!-- Bottom Row: Description + Due Date -->
    <div class="header-bottom-row">
      {% if work_item.workcycle.description %}
      <p class="header-description">{{ work_item.workcycle.description }}</p>
      {% else %}
      <p class="header-description" style="color: var(--soft-text-muted); font-style: italic;">No description provided</p>
      {% endif %}
      <div class="header-due">
        <i class="far fa-calendar-alt"></i>
        Due {{ work_item.workcycle.due_at|date:"M d, Y · g:i A" }}
      </div>
    </div>
  </div>

  <!-- Compact Main Grid -->
  <div class="main-grid-compact">
    <!-- Details Panel -->
    <div class="panel-compact">
      <div class="panel-header-compact">
        <i class="fas fa-info-circle" style="color: var(--soft-cyan);"></i>
        Status & Details
      </div>
      <div class="panel-body-compact">
        <!-- Status Section -->
        <div class="status-section-compact">
          <div class="section-label-compact">Current Status</div>
          
          {% if work_item.status != "done" %}
          <!-- Status Indicator -->
          <div class="status-indicator">
            <i class="fas fa-hand-pointer"></i>
            <span>Click to update your work status</span>
          </div>
          
          <!-- Status Buttons -->
          <div class="status-toggle-compact">
            <form method="post" style="flex: 1;">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_status">
              <input type="hidden" name="status" value="not_started">
              <button type="submit" class="status-btn-compact {% if work_item.status == 'not_started' %}active-not-started{% endif %}">
                <i class="fas fa-circle"></i>
                <span>Not Started</span>
              </button>
            </form>
            <form method="post" style="flex: 1;">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_status">
              <input type="hidden" name="status" value="working_on_it">
              <button type="submit" class="status-btn-compact {% if work_item.status == 'working_on_it' %}active-progress{% endif %}">
                <i class="fas fa-spinner {% if work_item.status == 'working_on_it' %}spin{% endif %}"></i>
                <span>In Progress</span>
              </button>
            </form>
          </div>
          {% else %}
          <!-- Completed State -->
          <div class="completed-alert-compact">
            <div>
              <i class="fas fa-check-circle"></i>
              <span>Completed</span>
            </div>
            
            {% if work_item.review_decision == "pending" %}
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="undo_submit">
              <button type="submit" class="btn-undo-compact">
                <i class="fas fa-undo"></i>
                Undo
              </button>
            </form>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Meta Info -->
        <div class="meta-section-compact">
          <div class="meta-row-compact">
            <span class="meta-label-compact">Review Status</span>
            <span class="badge-status-compact {% if work_item.review_decision == 'approved' %}badge-approved{% elif work_item.review_decision == 'revision' %}badge-revision{% else %}badge-pending{% endif %}">
              {{ work_item.get_review_decision_display }}
            </span>
          </div>
          <div class="meta-row-compact">
            <span class="meta-label-compact">Submitted</span>
            <span class="meta-value-compact">
              {% if work_item.submitted_at %}
              <i class="fas fa-check-circle" style="color: var(--soft-green);"></i>
              {{ work_item.submitted_at|date:"M d, Y · H:i" }}
              {% else %}
              <i class="fas fa-clock" style="color: var(--soft-text-muted);"></i>
              Not yet
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Submit Button -->
        {% if work_item.status != "done" %}
        <div class="submit-section-compact">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="submit">
            <button type="submit" class="btn-submit-compact" {% if not attachments %}disabled{% endif %}>
              <i class="fas fa-check-circle"></i>
              Mark as Done & Submit
            </button>
          </form>
          {% if not attachments %}
          <div class="submit-hint-compact">Upload at least one attachment before submitting.</div>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Notes Panel -->
    <form method="post" class="panel-compact">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_context">
      <div class="panel-header-compact">
        <i class="fas fa-sticky-note" style="color: var(--soft-amber);"></i>
        Notes
      </div>
      <div class="panel-body-compact">
        <div class="form-group-compact">
          <label class="form-label-compact">Status Label</label>
          <input type="text" id="statusLabelInput" name="status_label" class="form-input-compact" 
                 placeholder="e.g. Waiting for documents" value="{{ work_item.status_label }}">
          <div class="chips-container-compact">
            <button type="button" class="status-chip-compact" data-value="Waiting for approval">Waiting for approval</button>
            <button type="button" class="status-chip-compact" data-value="In review">In review</button>
            <button type="button" class="status-chip-compact" data-value="Needs revision">Needs revision</button>
            <button type="button" class="status-chip-compact" data-value="On hold">On hold</button>
            <button type="button" class="status-chip-compact" data-value="For validation">For validation</button>
            <button type="button" class="status-chip-compact" data-value="Pending documents">Pending documents</button>
          </div>
        </div>
        <div class="form-group-compact">
          <label class="form-label-compact">Message</label>
          <textarea name="message" class="form-input-compact" rows="4" 
                    placeholder="Add notes or remarks here...">{{ work_item.message }}</textarea>
        </div>
        <button type="submit" class="btn-save-compact">
          <i class="fas fa-save"></i>
          Save Notes
        </button>
      </div>
    </form>
  </div>

  <!-- Compact Attachments Section -->
  <div class="attachments-section-compact">
    <h5 class="section-title-compact">
      <i class="fas fa-paperclip"></i>
      Attachments
    </h5>
    <div class="attachments-grid-compact">
      {% for key, label in attachment_types %}
      <a href="{% url 'user_app:work-item-attachments' work_item.id %}?type={{ key }}" class="attachment-card-compact">
        <i class="fas fa-folder-open attachment-icon-compact {% if key in uploaded_types %}uploaded{% else %}pending{% endif %}"></i>
        <div class="attachment-title-compact">{{ label }}</div>
        {% if key in uploaded_types %}
        <span class="badge-compact badge-uploaded-compact">Uploaded</span>
        {% else %}
        <span class="badge-compact badge-not-uploaded-compact">Not Uploaded</span>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("statusLabelInput");
  document.querySelectorAll(".status-chip-compact").forEach(chip => {
    chip.addEventListener("click", () => {
      input.value = chip.dataset.value;
      input.focus();
    });
  });
  
  // Add subtle hover effect to action buttons
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-1px)';
    });
    btn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
});
</script>

{% endblock %}