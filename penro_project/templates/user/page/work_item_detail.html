{% extends "user/layout/base.html" %}
{% block title %}Work Item{% endblock %}
{% block content %}

<style>
:root{
  --border:#e5e7eb;--text:#1f2937;--muted:#6b7280;
  --primary:#4f46e5;--success:#10b981;--info:#3b82f6;
  --warning:#f59e0b;--danger:#ef4444;
}

/* === Cards === */
.card{border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:1rem}
.card-header{background:#f8fafc;border-bottom:1px solid var(--border);font-weight:600}
.badge{font-size:.75rem;border-radius:999px;padding:.35rem .75rem}

/* === Status colors === */
.bg-not-started{background:#6b7280;color:#fff}
.bg-working{background:#3b82f6;color:#fff}
.bg-done{background:#10b981;color:#fff}

.bg-pending{background:#f59e0b;color:#111}
.bg-approved{background:#10b981;color:#fff}
.bg-needs-revision{background:#ef4444;color:#fff}

/* === Status buttons === */
.status-actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.4rem}
.status-btn{
  display:inline-flex;align-items:center;gap:.4rem;
  border:none;cursor:pointer;
  padding:.35rem .9rem;font-weight:600;
  transition:all .25s ease;position:relative
}
.status-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 6px 14px rgba(0,0,0,.15)}

.status-active{
  background:linear-gradient(135deg,#6366f1,#22d3ee);
  color:#111;box-shadow:0 8px 18px rgba(0,0,0,.25)
}
.status-active::after{
  content:"";position:absolute;inset:-4px;border-radius:inherit;
  border:2px solid rgba(99,102,241,.5);animation:pulse 1.4s infinite
}

.status-working .icon{animation:spin 1.4s linear infinite}
.status-active .icon{animation:bounce 1.1s infinite}

@keyframes spin{to{transform:rotate(360deg)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
@keyframes pulse{0%{opacity:.6}100%{opacity:0}}

.small-muted{font-size:.75rem;color:var(--muted)}
</style>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-start mb-3 border-bottom pb-2">
  <div>
    <h6 class="mb-1">
      <i class="fas fa-tasks text-primary me-1"></i>
      {{ work_item.workcycle.title }}
    </h6>
    <div class="small text-muted">
      <i class="far fa-calendar-alt me-1"></i>
      Due {{ work_item.workcycle.due_at|date:"M d, Y · H:i" }}
    </div>
  </div>
 <div class="mt-3">
        <button type="button"
                class="btn btn-sm btn-outline-primary d-flex align-items-center gap-2"
                disabled>
          <i class="fas fa-comment-dots"></i>
          Send a message
          <span class="badge bg-secondary-subtle text-secondary ms-1">
            Coming soon
          </span>
        </button>
      </div>
  <a href="{% url 'user_app:work-items' %}" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i>Back
  </a>
  
</div>


<!-- DETAILS -->
<div class="card">
  <div class="card-header d-flex justify-content-between">
    <span><i class="fas fa-info-circle text-primary me-1"></i>Details</span>
    <span class="badge
      {% if work_item.review_decision == 'pending' %}bg-pending
      {% elif work_item.review_decision == 'approved' %}bg-approved
      {% elif work_item.review_decision == 'needs_revision' %}bg-needs-revision{% endif %}">
      {{ work_item.get_review_decision_display }}
    </span>
  </div>

  <div class="card-body">

    <!-- STATUS -->
    <div class="mb-3">
      <strong class="small">Work Status</strong>
      <div class="small-muted">Click to notify progress</div>

      {% if can_edit %}
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_status">

        <div class="status-actions">
          {% for v,l in status_choices %}
            {% if v != "done" %}
            <button type="submit"
                    name="status"
                    value="{{ v }}"
                    class="status-btn badge
                    {% if work_item.status == v %}
                      status-active
                    {% elif v == 'not_started' %}
                      bg-not-started
                    {% elif v == 'working_on_it' %}
                      bg-working
                    {% endif %}">
              <i class="fas
                {% if v == 'not_started' %}fa-pause-circle
                {% elif v == 'working_on_it' %}fa-spinner{% endif %}
                icon"></i>
              {{ l }}
            </button>
            {% endif %}
          {% endfor %}
        </div>
      </form>
      {% else %}
        <span class="badge
          {% if work_item.status == 'not_started' %}bg-not-started
          {% elif work_item.status == 'working_on_it' %}bg-working
          {% elif work_item.status == 'done' %}bg-done{% endif %}">
          {{ work_item.get_status_display }}
        </span>
      {% endif %}
    </div>

    <!-- SUBMISSION TIME -->
    <div class="small text-muted border-top pt-2">
      <i class="far fa-clock me-1"></i>
      Submitted:
      {% if work_item.submitted_at %}
        {{ work_item.submitted_at|date:"M d, Y · H:i" }}
      {% else %}
        <span class="text-warning">Not submitted</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- NOTES -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-comment-dots me-1"></i>Notes
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_context">

      <input class="form-control form-control-sm mb-2"
             name="status_label"
             value="{{ work_item.status_label }}"
             placeholder="Status label">

      <textarea class="form-control form-control-sm mb-2"
                name="message"
                rows="3">{{ work_item.message }}</textarea>

      <button class="btn btn-sm btn-outline-primary">
        <i class="fas fa-save me-1"></i>Save
      </button>
    </form>
  </div>
</div>

<!-- ATTACHMENTS (VIEW) -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-paperclip me-1"></i>Attachments
  </div>
  <div class="card-body">
    {% if work_item.attachments.all %}
      <ul class="list-group list-group-flush">
        {% for f in work_item.attachments.all %}
        <li class="list-group-item d-flex justify-content-between">
          <a href="{{ f.file.url }}" download class="small">
            <i class="far fa-file me-1"></i>{{ f.file.name|slice:"-35:" }}
          </a>
          <span class="small text-muted">
            {{ f.uploaded_at|date:"M d, Y · H:i" }}
          </span>
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="small text-muted fst-italic">No attachments yet</div>
    {% endif %}
  </div>
</div>

<!-- ATTACHMENTS (UPLOAD / SUBMIT) -->
<div class="card">
  <div class="card-header">
    <i class="fas fa-upload me-1"></i>
    {% if can_edit %}Submit Work{% else %}Add Attachment{% endif %}
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden"
             name="action"
             value="{% if can_edit %}submit_work{% else %}add_attachment{% endif %}">

      <input type="file"
             name="attachments"
             multiple
             class="form-control form-control-sm mb-2"
             required>

      <button class="btn btn-sm {% if can_edit %}btn-success{% else %}btn-outline-primary{% endif %}">
        <i class="fas fa-paper-plane me-1"></i>
        {% if can_edit %}Submit{% else %}Upload{% endif %}
      </button>
    </form>
  </div>
</div>

{% endblock %}
